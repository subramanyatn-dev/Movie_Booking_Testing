package base;

import io.restassured.RestAssured;
import io.restassured.response.Response;
import io.restassured.specification.RequestSpecification;
import org.testng.annotations.BeforeClass;
import utils.ConfigLoader;

public class BaseTest {
    protected RequestSpecification request;
    protected String baseUrl;
    protected String token;

    @BeforeClass
    public void setup() {
        baseUrl = ConfigLoader.get("base.url");
        String username = ConfigLoader.get("username");
        String password = ConfigLoader.get("password");

        // Step 1: Get auth_code
        Response loginRes = RestAssured.given()
                .baseUri(baseUrl)
                .header("Content-Type", "application/x-www-form-urlencoded")
                .formParam("username", username)
                .formParam("password", password)
                .post("/OAuthRestApi/webapi/auth/login");

        loginRes.then().statusCode(200);
        String authCode = loginRes.jsonPath().getString("auth_code");

        // Step 2: Get token
        Response tokenRes = RestAssured.given()
                .baseUri(baseUrl)
                .header("Content-Type", "application/x-www-form-urlencoded")
                .formParam("auth_code", authCode)
                .post("/OAuthRestApi/webapi/auth/token");

        tokenRes.then().statusCode(200);
        token = tokenRes.jsonPath().getString("access_token");

        // Common request object for all test cases
        RestAssured.baseURI = baseUrl + "/MovieAPI/BookingService";
        request = RestAssured.given()
                .header("Content-Type", "application/x-www-form-urlencoded")
                .header("Accept", "application/json")
                .header("Authorization", "Bearer " + token);
    }
}

